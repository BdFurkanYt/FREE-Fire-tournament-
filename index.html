:<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {--primary-color: #7c3aed;--secondary-color: #a855f7;--accent-color: #f59e0b;--dark-bg: #0f0f23;--card-bg: #1a1a2e;--text-primary: #ffffff;--text-secondary: #a0a0b8;--success-color: #10b981;--danger-color: #ef4444;--warning-color: #f59e0b;}
        * {margin: 0;padding: 0;box-sizing: border-box;}
        body {font-family: 'Rajdhani', sans-serif;background-color: var(--dark-bg);color: var(--text-primary);min-height: 100vh;overflow-x: hidden;}
        .container {max-width: 1200px;margin: 0 auto;padding: 0 15px;}
        .hidden { display: none !important; }
        .app-loader { display: flex; justify-content: center; align-items: center; height: 100vh; font-size: 24px; flex-direction: column; gap: 10px; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 4px solid var(--primary-color); width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        header {background: linear-gradient(135deg, var(--card-bg) 0%, #16213e 100%);padding: 15px 0;box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);position: sticky;top: 0;z-index: 100;}
        .header-content {display: flex;justify-content: space-between;align-items: center;}
        .logo {font-family: 'Orbitron', sans-serif;font-size: 28px;font-weight: 900;color: var(--primary-color);text-shadow: 0 0 10px rgba(124, 58, 237, 0.5);display: flex;align-items: center;}
        .logo i {margin-right: 10px;font-size: 30px;}
        .admin-info {display: flex;align-items: center;gap: 15px;}
        .admin-name {font-weight: 600;font-size: 18px;}
        .logout-btn {background: linear-gradient(135deg, var(--danger-color), #dc2626);border: none;color: white;padding: 8px 15px;border-radius: 5px;font-weight: 600;cursor: pointer;transition: all 0.3s ease;}
        .logout-btn:hover {background: linear-gradient(135deg, #dc2626, var(--danger-color));transform: scale(1.02);}
        .admin-layout {display: flex;min-height: calc(100vh - 70px);}
        .sidebar {width: 250px;background: linear-gradient(135deg, var(--card-bg), #16213e);padding: 20px 0;box-shadow: 5px 0 15px rgba(0, 0, 0, 0.2);}
        .sidebar-menu {list-style: none;}
        .sidebar-item {margin-bottom: 5px;}
        .sidebar-link {display: flex;align-items: center;padding: 15px 20px;color: var(--text-secondary);text-decoration: none;font-weight: 600;font-size: 18px;transition: all 0.3s ease;}
        .sidebar-link:hover, .sidebar-link.active {background-color: rgba(124, 58, 237, 0.2);color: var(--primary-color);}
        .sidebar-link i {margin-right: 15px;font-size: 20px;}
        .main-content {flex: 1;padding: 30px; overflow-y: auto;}
        .page {display: none;}
        .page.active {display: block;}
        .page-header {display: flex;justify-content: space-between;align-items: center;margin-bottom: 30px;}
        .page-title {font-family: 'Orbitron', sans-serif;font-size: 32px;font-weight: 700;color: var(--primary-color);}
        .btn {padding: 10px 20px;border: none;border-radius: 8px;font-size: 16px;font-weight: 600;cursor: pointer;transition: all 0.3s ease;}
        .btn-primary {background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));color: white;}
        .btn-success {background: linear-gradient(135deg, var(--success-color), #059669);color: white;}
        .btn-danger {background: linear-gradient(135deg, var(--danger-color), #dc2626);color: white;}
        .card {background: linear-gradient(135deg, var(--card-bg), #16213e);border-radius: 15px;padding: 25px;margin-bottom: 20px;box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);}
        .card-title {font-size: 22px;font-weight: 700;margin-bottom: 20px;color: var(--primary-color);}
        .table-container {overflow-x: auto;}
        table {width: 100%;border-collapse: collapse;}
        th, td {padding: 15px;text-align: left;border-bottom: 1px solid rgba(255, 255, 255, 0.1);}
        th {background-color: rgba(124, 58, 237, 0.1);font-weight: 700;color: var(--primary-color);}
        tr:hover {background-color: rgba(124, 58, 237, 0.05);}
        .status-badge {display: inline-block;padding: 5px 10px;border-radius: 20px;font-size: 14px;font-weight: 600;text-transform: capitalize;}
        .status-pending {background-color: rgba(245, 158, 11, 0.2);color: var(--warning-color);}
        .status-successful {background-color: rgba(16, 185, 129, 0.2);color: var(--success-color);}
        .status-rejected {background-color: rgba(239, 68, 68, 0.2);color: var(--danger-color);}
        .form-group {margin-bottom: 20px;}
        .form-label {display: block;margin-bottom: 8px;font-weight: 600;font-size: 18px;}
        .form-input, .form-textarea, select {width: 100%;padding: 12px 15px;background-color: rgba(255, 255, 255, 0.1);border: 2px solid rgba(124, 58, 237, 0.3);border-radius: 8px;color: white;font-size: 16px;transition: all 0.3s ease; font-family: 'Rajdhani', sans-serif;}
        .form-textarea {min-height: 100px;resize: vertical;}
        .form-input:focus, .form-textarea:focus {outline: none;border-color: var(--primary-color);background-color: rgba(124, 58, 237, 0.1);}
        .form-row {display: flex;gap: 20px;}
        .form-col {flex: 1;}
        .modal {display: none;position: fixed;top: 0;left: 0;width: 100%;height: 100%;background-color: rgba(0, 0, 0, 0.7);z-index: 1000;justify-content: center;align-items: center;}
        .modal.active {display: flex;}
        .modal-content {background: linear-gradient(135deg, var(--card-bg), #16213e);border-radius: 15px;padding: 30px;width: 90%;max-width: 600px;max-height: 90vh;overflow-y: auto;box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);}
        .modal-header {display: flex;justify-content: space-between;align-items: center;margin-bottom: 20px;}
        .modal-title {font-size: 24px;font-weight: 700;color: var(--primary-color);}
        .modal-close {background: none;border: none;color: var(--text-secondary);font-size: 24px;cursor: pointer;transition: color 0.3s ease;}
        .modal-close:hover {color: var(--danger-color);}
        .auth-container {display: flex;justify-content: center;align-items: center;min-height: 100vh;}
        .auth-card {width: 100%;max-width: 450px;background: linear-gradient(135deg, var(--card-bg), #16213e);border-radius: 15px;padding: 40px;box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);}
        .auth-title {font-size: 32px;font-weight: 700;margin-bottom: 30px;text-align: center;color: var(--primary-color);}
        .dynamic-list-item { background-color: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .dynamic-list-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .dynamic-list-item-header h4 { margin: 0; color: var(--secondary-color); }
        .dynamic-list-item .form-group { margin-bottom: 10px; }
        .dynamic-list-item .form-row { margin-bottom: 10px; }
        .dynamic-slider-item { display: flex; align-items: center; gap: 10px; background-color: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; margin-bottom: 10px; }
        .dynamic-slider-item input { flex: 1; }
        .notification {position: fixed;top: 80px;right: 20px;padding: 15px 20px;border-radius: 8px;color: white;font-weight: 600;box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);transform: translateX(120%);transition: transform 0.3s ease;z-index: 1001;}
        .notification.show {transform: translateX(0);}
        .notification.success {background-color: var(--success-color);}
        .notification.error {background-color: var(--danger-color);}
        @media (max-width: 768px) {.admin-layout {flex-direction: column;}.sidebar {width: 100%;}.form-row {flex-direction: column;}.page-header {flex-direction: column;gap: 15px;align-items: flex-start;}}
    </style>
</head>
<body>
    <div id="app-loader" class="app-loader">
        <div class="spinner"></div>
        <span>Loading Admin Panel...</span>
    </div>

    <div id="auth-container" class="auth-container hidden">
        <div class="auth-card">
            <h1 class="auth-title">Admin Login</h1>
            <form id="admin-login-form">
                <div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="admin-email" required></div>
                <div class="form-group"><label class="form-label">Password</label><input type="password" class="form-input" id="admin-password" required></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
            </form>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <header>
            <div class="container">
                <div class="header-content">
                    <div class="logo"><i class="fas fa-cogs"></i><span>Admin Panel</span></div>
                    <div class="admin-info"><span class="admin-name" id="admin-name">Admin</span><button class="logout-btn" id="logout-btn">Logout</button></div>
                </div>
            </div>
        </header>
        <div class="admin-layout">
            <aside class="sidebar">
                <ul class="sidebar-menu">
                    <li class="sidebar-item"><a href="#" class="sidebar-link active" data-page="dashboard"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a></li>
                    <li class="sidebar-item"><a href="#" class="sidebar-link" data-page="tournaments"><i class="fas fa-trophy"></i><span>Tournaments</span></a></li>
                    <li class="sidebar-item"><a href="#" class="sidebar-link" data-page="deposits"><i class="fas fa-arrow-down"></i><span>Deposits</span></a></li>
                    <li class="sidebar-item"><a href="#" class="sidebar-link" data-page="withdrawals"><i class="fas fa-arrow-up"></i><span>Withdrawals</span></a></li>
                    <li class="sidebar-item"><a href="#" class="sidebar-link" data-page="users"><i class="fas fa-users"></i><span>Users</span></a></li>
                    <li class="sidebar-item"><a href="#" class="sidebar-link" data-page="settings"><i class="fas fa-cog"></i><span>Settings</span></a></li>
                </ul>
            </aside>
            <main class="main-content">
                <div id="dashboard-page" class="page active"><div class="page-header"><h1 class="page-title">Dashboard</h1></div><div class="card"><h2 class="card-title">Statistics</h2><div class="form-row"><div class="form-col"><div class="card" style="background-color: rgba(124, 58, 237, 0.1);"><h3 style="color: var(--primary-color); margin-bottom: 10px;">Total Users</h3><p style="font-size: 32px; font-weight: 700;" id="total-users">0</p></div></div><div class="form-col"><div class="card" style="background-color: rgba(16, 185, 129, 0.1);"><h3 style="color: var(--success-color); margin-bottom: 10px;">Total Tournaments</h3><p style="font-size: 32px; font-weight: 700;" id="total-tournaments">0</p></div></div><div class="form-col"><div class="card" style="background-color: rgba(245, 158, 11, 0.1);"><h3 style="color: var(--warning-color); margin-bottom: 10px;">Pending Requests</h3><p style="font-size: 32px; font-weight: 700;" id="pending-requests">0</p></div></div></div></div></div>
                <div id="tournaments-page" class="page"><div class="page-header"><h1 class="page-title">Tournaments</h1><button class="btn btn-primary" id="add-tournament-btn">Add Tournament</button></div><div class="card"><div class="table-container"><table><thead><tr><th>Title</th><th>Entry Fee</th><th>Prize Pool</th><th>Players</th><th>Status</th><th>Actions</th></tr></thead><tbody id="tournaments-table"></tbody></table></div></div></div>
                <div id="deposits-page" class="page"><div class="page-header"><h1 class="page-title">Deposit Requests</h1></div><div class="card"><div class="table-container"><table><thead><tr><th>User</th><th>Amount</th><th>Method</th><th>Transaction ID</th><th>Status</th><th>Actions</th></tr></thead><tbody id="deposits-table"></tbody></table></div></div></div>
                <div id="withdrawals-page" class="page"><div class="page-header"><h1 class="page-title">Withdrawal Requests</h1></div><div class="card"><div class="table-container"><table><thead><tr><th>User</th><th>Amount</th><th>To Account</th><th>Method</th><th>Status</th><th>Actions</th></tr></thead><tbody id="withdrawals-table"></tbody></table></div></div></div>
                <div id="users-page" class="page"><div class="page-header"><h1 class="page-title">Users</h1></div><div class="card"><div class="table-container"><table><thead><tr><th>Name</th><th>Email</th><th>Wallet</th><th>Winnings</th><th>Actions</th></tr></thead><tbody id="users-table"></tbody></table></div></div></div>
                <div id="settings-page" class="page"><div class="page-header"><h1 class="page-title">Settings</h1></div><form id="settings-form"><div class="card"><h2 class="card-title">App Settings</h2><div class="form-group"><label class="form-label">App Name</label><input type="text" class="form-input" id="settings-app-name"></div><div class="form-group"><label class="form-label">Announcement Text</label><input type="text" class="form-input" id="settings-announcement-text"></div><div class="form-row"><div class="form-col"><div class="form-group"><label class="form-label">Min Deposit Amount</label><input type="number" class="form-input" id="settings-min-deposit"></div></div><div class="form-col"><div class="form-group"><label class="form-label">Min Withdrawal Amount</label><input type="number" class="form-input" id="settings-min-withdrawal"></div></div></div></div><div class="card"><h2 class="card-title">Slider Images</h2><div id="slider-images-container"></div><button type="button" class="btn btn-primary" id="add-slider-image-btn" style="margin-top: 10px;">Add New Image</button></div><div class="card"><h2 class="card-title">Deposit Methods</h2><div id="deposit-methods-container"></div><button type="button" class="btn btn-primary" id="add-deposit-method-btn" style="margin-top: 10px;">Add Deposit Method</button></div><div class="card"><h2 class="card-title">Withdrawal Methods</h2><div id="withdrawal-methods-container"></div><button type="button" class="btn btn-primary" id="add-withdrawal-method-btn" style="margin-top: 10px;">Add Withdrawal Method</button></div><div class="card"><h2 class="card-title">Content Pages</h2><div class="form-group"><label class="form-label">Privacy Policy</label><textarea class="form-textarea" id="settings-privacy-policy"></textarea></div><div class="form-group"><label class="form-label">Terms & Conditions</label><textarea class="form-textarea" id="settings-terms-conditions"></textarea></div></div><button type="submit" class="btn btn-success" style="width: 100%; padding: 15px; font-size: 18px;">Save All Settings</button></form></div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="tournament-modal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title" id="tournament-modal-title">Add Tournament</h2><button class="modal-close">&times;</button></div><form id="tournament-form"><div class="form-group"><label class="form-label">Title</label><input type="text" class="form-input" id="t-title" required></div><div class="form-group"><label class="form-label">Image URL</label><input type="text" class="form-input" id="t-imageUrl" placeholder="Optional tournament image link"></div><div class="form-row"><div class="form-col"><div class="form-group"><label class="form-label">Entry Fee (৳)</label><input type="number" class="form-input" id="t-entryFee" required></div></div><div class="form-col"><div class="form-group"><label class="form-label">Prize Pool (৳)</label><input type="number" class="form-input" id="t-prizePool" required></div></div></div><div class="form-group"><label class="form-label">Max Players</label><input type="number" class="form-input" id="t-maxPlayers" required></div><div class="form-group"><label class="form-label">Match Start Time</label><input type="datetime-local" class="form-input" id="t-matchStartTime"></div><div class="form-row"><div class="form-col"><div class="form-group"><label class="form-label">Room ID</label><input type="text" class="form-input" id="t-roomId"></div></div><div class="form-col"><div class="form-group"><label class="form-label">Room Password</label><input type="text" class="form-input" id="t-roomPassword"></div></div></div><div class="form-group"><label class="form-label">Status</label><select class="form-input" id="t-status"><option value="upcoming">Upcoming</option><option value="ongoing">Ongoing</option><option value="completed">Completed</option></select></div><button type="submit" class="btn btn-primary">Save Tournament</button></form></div></div>
    <div class="notification" id="notification"></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = {
  apiKey: "AIzaSyD1omzAaxkH0evnPYFOOAqfmcVTcOTLPNM",
  authDomain: "ff-torniment.firebaseapp.com",
  projectId: "ff-torniment",
  storageBucket: "ff-torniment.firebasestorage.app",
  messagingSenderId: "10771921067",
  appId: "1:10771921067:web:4dbe1ad167750da7559fee"
};
        
        const ADMIN_UIDS = ["zQKq42r4A4T2go5FpkujyxFcqrD2"]; 
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const loader = document.getElementById('app-loader');
        const authContainer = document.getElementById('auth-container');
        const mainAppContainer = document.getElementById('main-app');
        const notification = document.getElementById('notification');
        let currentTournamentId = null;

        auth.onAuthStateChanged(async user => {
            if (user) {
                try {
                    if (!ADMIN_UIDS.includes(user.uid)) throw new Error("Access Denied. Not an admin UID.");
                    const adminDoc = await db.collection('admins').doc(user.uid).get();
                    if (!adminDoc.exists || adminDoc.data().isAdmin !== true) throw new Error("You are not an authorized admin in Firestore.");
                    
                    loader.classList.add('hidden');
                    authContainer.classList.add('hidden');
                    mainAppContainer.classList.remove('hidden');
                    document.getElementById('admin-name').textContent = user.email;
                    showPage('dashboard');
                } catch (error) {
                    showNotification(error.message, "error");
                    auth.signOut();
                }
            } else {
                loader.classList.add('hidden');
                authContainer.classList.remove('hidden');
                mainAppContainer.classList.add('hidden');
            }
        });

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(`${pageId}-page`).classList.add('active');
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.toggle('active', l.dataset.page === pageId));
            const dataLoaders = {
                dashboard: loadDashboardData, tournaments: loadTournaments,
                deposits: loadPaymentRequests, withdrawals: loadPaymentRequests,
                users: loadUsers, settings: loadSettings
            };
            if (dataLoaders[pageId]) dataLoaders[pageId]();
        }

        function loadDashboardData() {
            db.collection('users').get().then(s => document.getElementById('total-users').textContent = s.size);
            db.collection('tournaments').get().then(s => document.getElementById('total-tournaments').textContent = s.size);
            db.collection('paymentRequests').where('status', '==', 'pending').get().then(s => document.getElementById('pending-requests').textContent = s.size);
        }

        function loadTournaments() {
            db.collection('tournaments').orderBy('title').get().then(snapshot => {
                const tbody = document.getElementById('tournaments-table');
                tbody.innerHTML = '';
                snapshot.forEach(doc => {
                    const t = { id: doc.id, ...doc.data() };
                    tbody.innerHTML += `<tr><td>${t.title}</td><td>৳${t.entryFee}</td><td>৳${t.prizePool}</td><td>${t.joinedPlayers || 0}/${t.maxPlayers}</td><td><span class="status-badge status-${t.status}">${t.status}</span></td><td><button class="btn btn-primary btn-sm" data-action="edit-tournament" data-id="${t.id}">Edit</button> <button class="btn btn-danger btn-sm" data-action="delete-tournament" data-id="${t.id}">Delete</button></td></tr>`;
                });
            });
        }
        
        function loadPaymentRequests() {
            db.collection('paymentRequests').orderBy('timestamp', 'desc').get().then(snapshot => {
                const depositsTbody = document.getElementById('deposits-table');
                const withdrawalsTbody = document.getElementById('withdrawals-table');
                depositsTbody.innerHTML = '';
                withdrawalsTbody.innerHTML = '';
                snapshot.forEach(doc => {
                    const req = { id: doc.id, ...doc.data() };
                    const actionsHTML = req.status === 'pending'
                        ? `<button class="btn btn-success btn-sm" data-action="approve-${req.type}" data-id="${req.id}" data-uid="${req.userId}" data-amount="${req.amount}">Approve</button> <button class="btn btn-danger btn-sm" data-action="reject-request" data-id="${req.id}">Reject</button>`
                        : 'N/A';
                    
                    if (req.type === 'deposit') {
                        depositsTbody.innerHTML += `<tr><td>${req.userName}</td><td>৳${req.amount}</td><td>${req.methodName}</td><td>${req.transactionId}</td><td><span class="status-badge status-${req.status}">${req.status}</span></td><td>${actionsHTML}</td></tr>`;
                    } else {
                         withdrawalsTbody.innerHTML += `<tr><td>${req.userName}</td><td>৳${req.amount}</td><td>${req.mfsNumber}</td><td>${req.methodName || 'N/A'}</td><td><span class="status-badge status-${req.status}">${req.status}</span></td><td>${actionsHTML}</td></tr>`;
                    }
                });
            });
        }
        
        function loadUsers() {
            db.collection('users').get().then(snapshot => {
                const tbody = document.getElementById('users-table');
                tbody.innerHTML = '';
                snapshot.forEach(doc => {
                    const u = { id: doc.id, ...doc.data() };
                    tbody.innerHTML += `<tr><td>${u.name}</td><td>${u.email}</td><td>৳${u.walletBalance || 0}</td><td>৳${u.winningsBalance || 0}</td><td><button class="btn btn-primary btn-sm" data-action="edit-user" data-id="${u.id}">Edit Balance</button></td></tr>`;
                });
            });
        }

        function loadSettings() {
            db.collection('settings').doc('appConfig').get().then(doc => {
                if (!doc.exists) return;
                const s = doc.data();
                document.getElementById('settings-app-name').value = s.appName || '';
                document.getElementById('settings-announcement-text').value = s.announcementText || '';
                document.getElementById('settings-min-deposit').value = s.minDeposit || '';
                document.getElementById('settings-min-withdrawal').value = s.minWithdrawal || '';
                document.getElementById('settings-privacy-policy').value = s.privacyPolicy || '';
                document.getElementById('settings-terms-conditions').value = s.termsConditions || '';
                renderDynamicList('slider-images-container', s.sliderImages || []);
                renderDynamicList('deposit-methods-container', s.depositMethods || [], true);
                renderDynamicList('withdrawal-methods-container', s.withdrawalMethods || [], true);
            });
        }
        
        function handleAdminLogin(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.disabled = true;
            btn.textContent = 'Logging in...';
            auth.signInWithEmailAndPassword(
                document.getElementById('admin-email').value,
                document.getElementById('admin-password').value
            ).catch(err => showNotification(err.message, 'error'))
             .finally(() => { btn.disabled = false; btn.textContent = 'Login'; });
        }

        function handleLogout() { auth.signOut(); }
        
        function handleTournamentSubmit(e) {
            e.preventDefault();
            const startTimeValue = document.getElementById('t-matchStartTime').value;
            const data = {
                title: document.getElementById('t-title').value, 
                imageUrl: document.getElementById('t-imageUrl').value,
                entryFee: parseInt(document.getElementById('t-entryFee').value),
                prizePool: parseInt(document.getElementById('t-prizePool').value), 
                maxPlayers: parseInt(document.getElementById('t-maxPlayers').value),
                status: document.getElementById('t-status').value,
                roomId: document.getElementById('t-roomId').value,
                roomPassword: document.getElementById('t-roomPassword').value,
                matchStartTime: startTimeValue ? firebase.firestore.Timestamp.fromDate(new Date(startTimeValue)) : null,
            };
            const promise = currentTournamentId 
                ? db.collection('tournaments').doc(currentTournamentId).update(data)
                : db.collection('tournaments').add({...data, joinedPlayers: 0});
            promise.then(() => {
                showNotification(`Tournament ${currentTournamentId ? 'updated' : 'added'}!`, 'success');
                document.getElementById('tournament-modal').classList.remove('active');
                loadTournaments();
            }).catch(err => showNotification(err.message, 'error'));
        }

        function handleSettingsSubmit(e) {
            e.preventDefault();
            const settings = {
                appName: document.getElementById('settings-app-name').value,
                announcementText: document.getElementById('settings-announcement-text').value,
                minDeposit: parseInt(document.getElementById('settings-min-deposit').value) || 0,
                minWithdrawal: parseInt(document.getElementById('settings-min-withdrawal').value) || 0,
                privacyPolicy: document.getElementById('settings-privacy-policy').value,
                termsConditions: document.getElementById('settings-terms-conditions').value,
                sliderImages: getDynamicListValues('slider-images-container'),
                depositMethods: getDynamicListValues('deposit-methods-container', true),
                withdrawalMethods: getDynamicListValues('withdrawal-methods-container', true)
            };
            db.collection('settings').doc('appConfig').set(settings, { merge: true })
                .then(() => showNotification('Settings saved!', 'success'))
                .catch(err => showNotification(err.message, 'error'));
        }
        
        document.body.addEventListener('click', e => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const { action, id } = btn.dataset;

            if (action === 'edit-tournament') {
                db.collection('tournaments').doc(id).get().then(doc => {
                    currentTournamentId = id;
                    const t = doc.data();
                    document.getElementById('tournament-modal-title').textContent = 'Edit Tournament';
                    document.getElementById('t-title').value = t.title || '';
                    document.getElementById('t-imageUrl').value = t.imageUrl || '';
                    document.getElementById('t-entryFee').value = t.entryFee || '';
                    document.getElementById('t-prizePool').value = t.prizePool || '';
                    document.getElementById('t-maxPlayers').value = t.maxPlayers || '';
                    document.getElementById('t-status').value = t.status || 'upcoming';
                    document.getElementById('t-roomId').value = t.roomId || '';
                    document.getElementById('t-roomPassword').value = t.roomPassword || '';
                    if (t.matchStartTime) {
                        const d = t.matchStartTime.toDate();
                        const ISODate = new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                        document.getElementById('t-matchStartTime').value = ISODate;
                    } else {
                         document.getElementById('t-matchStartTime').value = '';
                    }
                    document.getElementById('tournament-modal').classList.add('active');
                });
            } else if (action === 'delete-tournament') {
                if (confirm('Are you sure?')) db.collection('tournaments').doc(id).delete().then(loadTournaments);
            } else if (action === 'approve-deposit' || action === 'approve-withdrawal') {
                const { uid, amount } = btn.dataset;
                const field = action === 'approve-deposit' ? 'walletBalance' : 'winningsBalance';
                const increment = action === 'approve-deposit' ? Number(amount) : -Number(amount);
                db.collection('users').doc(uid).update({ [field]: firebase.firestore.FieldValue.increment(increment) })
                    .then(() => db.collection('paymentRequests').doc(id).update({ status: 'successful' }))
                    .then(() => { showNotification('Request approved!', 'success'); loadPaymentRequests(); });
            } else if (action === 'reject-request') {
                db.collection('paymentRequests').doc(id).update({ status: 'rejected' })
                    .then(() => { showNotification('Request rejected.', 'success'); loadPaymentRequests(); });
            } else if (action === 'edit-user') {
                 db.collection('users').doc(id).get().then(doc => {
                     const u = doc.data();
                     const newWallet = prompt("Wallet Balance:", u.walletBalance);
                     const newWinnings = prompt("Winnings Balance:", u.winningsBalance);
                     if (newWallet !== null && newWinnings !== null) {
                         db.collection('users').doc(id).update({
                             walletBalance: Number(newWallet), winningsBalance: Number(newWinnings)
                         }).then(loadUsers);
                     }
                 });
            } else if(action === 'remove-item') {
                 btn.closest('div[class^="dynamic-"]').remove();
            }
        });

        function renderDynamicList(containerId, items, isPaymentMethod = false) {
            document.getElementById(containerId).innerHTML = items.map(item => createDynamicListItemHTML(containerId, item, isPaymentMethod)).join('');
        }

        function addDynamicListItem(containerId, isPaymentMethod = false) {
            const itemHTML = createDynamicListItemHTML(containerId, {}, isPaymentMethod);
            document.getElementById(containerId).insertAdjacentHTML('beforeend', itemHTML);
        }

        function createDynamicListItemHTML(containerId, item, isPaymentMethod) {
            if (isPaymentMethod) {
                const title = containerId.includes('deposit') ? 'Deposit Method' : 'Withdrawal Method';
                return `<div class="dynamic-list-item">
                    <div class="dynamic-list-item-header"><h4>${title}</h4><button type="button" class="btn btn-danger btn-sm" data-action="remove-item">&times;</button></div>
                    <div class="form-row"><div class="form-col"><div class="form-group"><label class="form-label">Name</label><input type="text" class="form-input" data-field="name" value="${item.name || ''}"></div></div><div class="form-col"><div class="form-group"><label class="form-label">Number</label><input type="text" class="form-input" data-field="number" value="${item.number || ''}"></div></div></div>
                    <div class="form-row"><div class="form-col"><div class="form-group"><label class="form-label">Icon URL</label><input type="text" class="form-input" data-field="iconUrl" value="${item.iconUrl || ''}"></div></div><div class="form-col"><div class="form-group"><label class="form-label">Type (e.g., Agent)</label><input type="text" class="form-input" data-field="type" value="${item.type || ''}"></div></div></div>
                </div>`;
            }
            return `<div class="dynamic-slider-item"><input type="text" class="form-input" placeholder="Image URL" value="${item || ''}"><button type="button" class="btn btn-danger btn-sm" data-action="remove-item">&times;</button></div>`;
        }

        function getDynamicListValues(containerId, isPaymentMethod = false) {
            const items = [];
            document.querySelectorAll(`#${containerId} > div`).forEach(itemDiv => {
                if (isPaymentMethod) {
                    const obj = {};
                    let hasValue = false;
                    itemDiv.querySelectorAll('input[data-field]').forEach(input => {
                        obj[input.dataset.field] = input.value;
                        if (input.value) hasValue = true;
                    });
                    if (hasValue) items.push(obj);
                } else {
                    const value = itemDiv.querySelector('input').value;
                    if (value) items.push(value);
                }
            });
            return items;
        }

        // --- GLOBAL EVENT LISTENERS ---
        document.getElementById('admin-login-form').addEventListener('submit', handleAdminLogin);
        document.getElementById('logout-btn').addEventListener('click', handleLogout);
        document.getElementById('tournament-form').addEventListener('submit', handleTournamentSubmit);
        document.getElementById('settings-form').addEventListener('submit', handleSettingsSubmit);
        document.querySelectorAll('.sidebar-link').forEach(link => link.addEventListener('click', e => showPage(e.currentTarget.dataset.page)));
        document.getElementById('add-tournament-btn').addEventListener('click', () => {
            currentTournamentId = null;
            document.getElementById('tournament-form').reset();
            document.getElementById('tournament-modal-title').textContent = 'Add Tournament';
            document.getElementById('tournament-modal').classList.add('active');
        });
        document.querySelectorAll('.modal-close').forEach(btn => btn.addEventListener('click', () => btn.closest('.modal').classList.remove('active')));
        document.getElementById('add-slider-image-btn').addEventListener('click', () => addDynamicListItem('slider-images-container'));
        document.getElementById('add-deposit-method-btn').addEventListener('click', () => addDynamicListItem('deposit-methods-container', true));
        document.getElementById('add-withdrawal-method-btn').addEventListener('click', () => addDynamicListItem('withdrawal-methods-container', true));
        
        function showNotification(message, type = 'success') {
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            setTimeout(() => notification.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>